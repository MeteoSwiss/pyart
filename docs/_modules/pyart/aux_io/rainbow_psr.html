
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyart.aux_io.rainbow_psr &#8212; pyart-mch 0.4.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pyart-mch 0.4.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyart.aux_io.rainbow_psr</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">pyart.aux_io.rainbow_psr</span>
<span class="sd">========================</span>

<span class="sd">Routines for reading RAINBOW PSR files (Used by SELEX)</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: generated/</span>

<span class="sd">    read_rainbow_psr</span>
<span class="sd">    read_rainbow_psr_spectra</span>
<span class="sd">    read_psr_header</span>
<span class="sd">    read_psr_cpi_header</span>
<span class="sd">    read_psr_spectra</span>
<span class="sd">    get_item_numbers</span>
<span class="sd">    get_field</span>
<span class="sd">    get_spectra_field</span>
<span class="sd">    get_Doppler_info</span>
<span class="sd">    get_noise_field</span>
<span class="sd">    convert_data</span>
<span class="sd">    get_library</span>
<span class="sd">    get_library_path</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># specific modules for this function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">..config</span> <span class="kn">import</span> <span class="n">FileMetadata</span>
<span class="kn">from</span> <span class="nn">..io.common</span> <span class="kn">import</span> <span class="n">_test_arguments</span>
<span class="kn">from</span> <span class="nn">..core.radar_spectra</span> <span class="kn">import</span> <span class="n">RadarSpectra</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">MissingOptionalDependency</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">subset_radar</span>
<span class="kn">from</span> <span class="nn">.rainbow_wrl</span> <span class="kn">import</span> <span class="n">read_rainbow_wrl</span>

<span class="c1"># Check existence of required libraries</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># `read_rainbow` as of wradlib version 1.0.0</span>
    <span class="kn">from</span> <span class="nn">wradlib.io</span> <span class="kn">import</span> <span class="n">read_Rainbow</span> <span class="k">as</span> <span class="n">read_rainbow</span>
    <span class="n">_WRADLIB_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">wradlib.io</span> <span class="kn">import</span> <span class="n">read_rainbow</span>
        <span class="n">_WRADLIB_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">_WRADLIB_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">PSR_FIELD_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;TXh&#39;</span><span class="p">:</span> <span class="s1">&#39;transmitted_power_h&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TXv&#39;</span><span class="p">:</span> <span class="s1">&#39;transmitted_power_v&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NADUhh&#39;</span><span class="p">:</span> <span class="s1">&#39;spectral_noise_power_hh_ADU&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NADUvv&#39;</span><span class="p">:</span> <span class="s1">&#39;spectral_noise_power_vv_ADU&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NADUhv&#39;</span><span class="p">:</span> <span class="s1">&#39;spectral_noise_power_hv_ADU&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NADUvh&#39;</span><span class="p">:</span> <span class="s1">&#39;spectral_noise_power_vh_ADU&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ShhADU&#39;</span><span class="p">:</span> <span class="s1">&#39;complex_spectra_hh_ADU&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SvvADU&#39;</span><span class="p">:</span> <span class="s1">&#39;complex_spectra_vv_ADU&#39;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="read_rainbow_psr"><a class="viewcode-back" href="../../../aux_io.html#pyart.aux_io.read_rainbow_psr">[docs]</a><span class="k">def</span> <span class="nf">read_rainbow_psr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filenames_psr</span><span class="p">,</span> <span class="n">field_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">additional_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_field_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">exclude_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">undo_txcorr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cpi</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">ang_tol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">azi_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">azi_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ele_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ele_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">rng_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a PSR file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the rainbow file to be used as reference.</span>
<span class="sd">    filenames_psr : list of str</span>
<span class="sd">        Name of the PSR files</span>
<span class="sd">    field_names : dict, optional</span>
<span class="sd">        Dictionary mapping RAINBOW field names to radar field names. If a</span>
<span class="sd">        data type found in the file does not appear in this dictionary or has</span>
<span class="sd">        a value of None it will not be placed in the radar.fields dictionary.</span>
<span class="sd">        A value of None, the default, will use the mapping defined in the</span>
<span class="sd">        Py-ART configuration file.</span>
<span class="sd">    additional_metadata : dict of dicts, optional</span>
<span class="sd">        Dictionary of dictionaries to retrieve metadata during this read.</span>
<span class="sd">        This metadata is not used during any successive file reads unless</span>
<span class="sd">        explicitly included.  A value of None, the default, will not</span>
<span class="sd">        introduct any addition metadata and the file specific or default</span>
<span class="sd">        metadata as specified by the Py-ART configuration file will be used.</span>
<span class="sd">    file_field_names : bool, optional</span>
<span class="sd">        True to use the MDV data type names for the field names. If this</span>
<span class="sd">        case the field_names parameter is ignored. The field dictionary will</span>
<span class="sd">        likely only have a &#39;data&#39; key, unless the fields are defined in</span>
<span class="sd">        `additional_metadata`.</span>
<span class="sd">    exclude_fields : list or None, optional</span>
<span class="sd">        List of fields to exclude from the radar object. This is applied</span>
<span class="sd">        after the `file_field_names` and `field_names` parameters. Set</span>
<span class="sd">        to None to include all fields specified by include_fields.</span>
<span class="sd">    include_fields : list or None, optional</span>
<span class="sd">        List of fields to include from the radar object. This is applied</span>
<span class="sd">        after the `file_field_names` and `field_names` parameters. Set</span>
<span class="sd">        to None to include all fields not specified by exclude_fields.</span>
<span class="sd">    undo_txcorr: Bool</span>
<span class="sd">        If True the correction of the transmitted power is removed from the</span>
<span class="sd">        noise signal</span>
<span class="sd">    cpi : str</span>
<span class="sd">        The CPI to use. Can be &#39;low_prf&#39;, &#39;intermediate_prf&#39;, &#39;high_prf&#39;,</span>
<span class="sd">        &#39;mean&#39;, &#39;all&#39;. If &#39;mean&#39; the mean within the angle step is taken</span>
<span class="sd">    ang_tol : float</span>
<span class="sd">        Tolerated angle distance between nominal radar angle and angle in</span>
<span class="sd">        PSR files</span>
<span class="sd">    azi_min, azi_max, ele_min, ele_max : float or None</span>
<span class="sd">        The minimum and maximum angles to keep (deg)</span>
<span class="sd">    rng_min, rng_max : float or None</span>
<span class="sd">        The minimum and maximum ranges to keep (m)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    radar : Radar</span>
<span class="sd">        Radar object containing data from PSR file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check that wradlib is available</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_WRADLIB_AVAILABLE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MissingOptionalDependency</span><span class="p">(</span>
            <span class="s2">&quot;wradlib is required to use read_rainbow_psr but is not installed&quot;</span><span class="p">)</span>

    <span class="c1"># test for non empty kwargs</span>
    <span class="n">_test_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># create radar object used as reference</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">radar</span> <span class="o">=</span> <span class="n">read_rainbow_wrl</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">radar</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">radar</span> <span class="o">=</span> <span class="n">subset_radar</span><span class="p">(</span>
            <span class="n">radar</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rng_min</span><span class="o">=</span><span class="n">rng_min</span><span class="p">,</span> <span class="n">rng_max</span><span class="o">=</span><span class="n">rng_max</span><span class="p">,</span> <span class="n">ele_min</span><span class="o">=</span><span class="n">ele_min</span><span class="p">,</span>
            <span class="n">ele_max</span><span class="o">=</span><span class="n">ele_max</span><span class="p">,</span> <span class="n">azi_min</span><span class="o">=</span><span class="n">azi_min</span><span class="p">,</span> <span class="n">azi_max</span><span class="o">=</span><span class="n">azi_max</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ee</span><span class="p">))</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to read file &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># create metadata retrieval object</span>
    <span class="k">if</span> <span class="n">field_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="n">PSR_FIELD_NAMES</span>
    <span class="n">filemetadata</span> <span class="o">=</span> <span class="n">FileMetadata</span><span class="p">(</span><span class="s1">&#39;PSR&#39;</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">additional_metadata</span><span class="p">,</span>
                                <span class="n">file_field_names</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="p">,</span>
                                <span class="n">include_fields</span><span class="p">)</span>
    <span class="n">dBADU_to_dBm_hh</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;dBADU_to_dBm_hh&#39;</span><span class="p">)</span>
    <span class="n">dBADU_to_dBm_vv</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;dBADU_to_dBm_vv&#39;</span><span class="p">)</span>
    <span class="n">mfloss_h</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;matched_filter_loss_h&#39;</span><span class="p">)</span>
    <span class="n">mfloss_v</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;matched_filter_loss_v&#39;</span><span class="p">)</span>
    <span class="n">pathatt</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;path_attenuation&#39;</span><span class="p">)</span>

    <span class="n">cpi_header</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">read_psr_cpi_headers</span><span class="p">(</span><span class="n">filenames_psr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cpi_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># keep only valid items</span>
    <span class="n">prfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;prfs&#39;</span><span class="p">]))</span>
    <span class="n">items</span><span class="p">,</span> <span class="n">radar</span> <span class="o">=</span> <span class="n">get_item_numbers</span><span class="p">(</span>
        <span class="n">radar</span><span class="p">,</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_start&#39;</span><span class="p">],</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_stop&#39;</span><span class="p">],</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_start&#39;</span><span class="p">],</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_stop&#39;</span><span class="p">],</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;prfs&#39;</span><span class="p">],</span>
        <span class="n">prfs</span><span class="p">,</span> <span class="n">cpi</span><span class="o">=</span><span class="n">cpi</span><span class="p">,</span> <span class="n">ang_tol</span><span class="o">=</span><span class="n">ang_tol</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">items</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No items matching radar object&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="n">get_field</span><span class="p">(</span>
            <span class="n">radar</span><span class="p">,</span> <span class="n">cpi_header</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">prfs</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span>
            <span class="n">undo_txcorr</span><span class="o">=</span><span class="n">undo_txcorr</span><span class="p">,</span> <span class="n">cpi</span><span class="o">=</span><span class="n">cpi</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;noisedBADU_hh&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBADU_vv&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBm_hh&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;noisedBm_vv&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBZ_hh&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBZ_vv&#39;</span><span class="p">):</span>
            <span class="n">field_data</span> <span class="o">=</span> <span class="n">get_noise_field</span><span class="p">(</span>
                <span class="n">radar</span><span class="p">,</span> <span class="n">field_data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>

        <span class="n">field_dict</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="n">field_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span>
        <span class="n">radar</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_dict</span><span class="p">)</span>

    <span class="c1"># get further metadata</span>
    <span class="n">pw_ind</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbpwidth&#39;</span><span class="p">]</span>

    <span class="n">dBADU_to_dBm_hh</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbdbmtologoffset&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]])</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;dBADU_to_dBm_hh&#39;</span><span class="p">:</span> <span class="n">dBADU_to_dBm_hh</span><span class="p">})</span>

    <span class="n">dBADU_to_dBm_vv</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbdpvdbmtologoffset&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]])</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;dBADU_to_dBm_vv&#39;</span><span class="p">:</span> <span class="n">dBADU_to_dBm_vv</span><span class="p">})</span>

    <span class="n">mfloss_h</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.gdrxmfloss&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]])</span>
    <span class="n">mfloss_v</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.gdrxmfloss&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]])</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;matched_filter_loss_h&#39;</span><span class="p">:</span> <span class="n">mfloss_h</span><span class="p">})</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;matched_filter_loss_v&#39;</span><span class="p">:</span> <span class="n">mfloss_v</span><span class="p">})</span>

    <span class="n">pathatt</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.rspathatt&#39;</span><span class="p">]])</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;path_attenuation&#39;</span><span class="p">:</span> <span class="n">pathatt</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">radar</span></div>


<div class="viewcode-block" id="read_rainbow_psr_spectra"><a class="viewcode-back" href="../../../aux_io.html#pyart.aux_io.read_rainbow_psr_spectra">[docs]</a><span class="k">def</span> <span class="nf">read_rainbow_psr_spectra</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filenames_psr</span><span class="p">,</span> <span class="n">field_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">additional_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_field_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">exclude_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">undo_txcorr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive_away</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">cpi</span><span class="o">=</span><span class="s1">&#39;low_prf&#39;</span><span class="p">,</span> <span class="n">ang_tol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">azi_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">azi_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ele_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ele_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">rng_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a PSR file to get the complex spectra</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the rainbow file to be used as reference.</span>
<span class="sd">    filenames_psr : list of str</span>
<span class="sd">        list of PSR file names</span>
<span class="sd">    field_names : dict, optional</span>
<span class="sd">        Dictionary mapping RAINBOW field names to radar field names. If a</span>
<span class="sd">        data type found in the file does not appear in this dictionary or has</span>
<span class="sd">        a value of None it will not be placed in the radar.fields dictionary.</span>
<span class="sd">        A value of None, the default, will use the mapping defined in the</span>
<span class="sd">        Py-ART configuration file.</span>
<span class="sd">    additional_metadata : dict of dicts, optional</span>
<span class="sd">        Dictionary of dictionaries to retrieve metadata during this read.</span>
<span class="sd">        This metadata is not used during any successive file reads unless</span>
<span class="sd">        explicitly included.  A value of None, the default, will not</span>
<span class="sd">        introduct any addition metadata and the file specific or default</span>
<span class="sd">        metadata as specified by the Py-ART configuration file will be used.</span>
<span class="sd">    file_field_names : bool, optional</span>
<span class="sd">        True to use the MDV data type names for the field names. If this</span>
<span class="sd">        case the field_names parameter is ignored. The field dictionary will</span>
<span class="sd">        likely only have a &#39;data&#39; key, unless the fields are defined in</span>
<span class="sd">        `additional_metadata`.</span>
<span class="sd">    exclude_fields : list or None, optional</span>
<span class="sd">        List of fields to exclude from the radar object. This is applied</span>
<span class="sd">        after the `file_field_names` and `field_names` parameters. Set</span>
<span class="sd">        to None to include all fields specified by include_fields.</span>
<span class="sd">    include_fields : list or None, optional</span>
<span class="sd">        List of fields to include from the radar object. This is applied</span>
<span class="sd">        after the `file_field_names` and `field_names` parameters. Set</span>
<span class="sd">        to None to include all fields not specified by exclude_fields.</span>
<span class="sd">    undo_txcorr: Bool</span>
<span class="sd">        If True the correction of the transmitted power is removed from the</span>
<span class="sd">        noise signal</span>
<span class="sd">    fold: Bool</span>
<span class="sd">        If True the spectra is folded so that 0-Doppler is in the middle</span>
<span class="sd">    positive_away: Bool</span>
<span class="sd">        If True the spectra is reversed so that positive velocities are</span>
<span class="sd">        away from the radar</span>
<span class="sd">    cpi : str</span>
<span class="sd">        The CPI to use. Can be &#39;low_prf&#39;, &#39;intermediate_prf&#39;, &#39;high_prf&#39; or</span>
<span class="sd">        &#39;all&#39;</span>
<span class="sd">    ang_tol : float</span>
<span class="sd">        Tolerated angle distance between nominal radar angle and angle in</span>
<span class="sd">        PSR files</span>
<span class="sd">    azi_min, azi_max, ele_min, ele_max : float or None</span>
<span class="sd">        The minimum and maximum angles to keep (deg)</span>
<span class="sd">    rng_min, rng_max : float or None</span>
<span class="sd">        The minimum and maximum ranges to keep (m)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    radar : Radar</span>
<span class="sd">        Radar object containing data from PSR file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check that wradlib is available</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_WRADLIB_AVAILABLE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MissingOptionalDependency</span><span class="p">(</span>
            <span class="s2">&quot;wradlib is required to use read_rainbow_psr but is not installed&quot;</span><span class="p">)</span>

    <span class="c1"># test for non empty kwargs</span>
    <span class="n">_test_arguments</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># create radar object used as reference</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">radar</span> <span class="o">=</span> <span class="n">read_rainbow_wrl</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">radar</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">rng_orig</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">radar</span> <span class="o">=</span> <span class="n">subset_radar</span><span class="p">(</span>
            <span class="n">radar</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rng_min</span><span class="o">=</span><span class="n">rng_min</span><span class="p">,</span> <span class="n">rng_max</span><span class="o">=</span><span class="n">rng_max</span><span class="p">,</span> <span class="n">ele_min</span><span class="o">=</span><span class="n">ele_min</span><span class="p">,</span>
            <span class="n">ele_max</span><span class="o">=</span><span class="n">ele_max</span><span class="p">,</span> <span class="n">azi_min</span><span class="o">=</span><span class="n">azi_min</span><span class="p">,</span> <span class="n">azi_max</span><span class="o">=</span><span class="n">azi_max</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">radar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No data within specified azimuth, elevation and&#39;</span>
                 <span class="s1">&#39; range limits&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ind_rng_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rng_orig</span> <span class="o">==</span> <span class="n">radar</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ind_rng_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rng_orig</span> <span class="o">==</span> <span class="n">radar</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ind_rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ind_rng_start</span><span class="p">,</span> <span class="n">ind_rng_end</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ee</span><span class="p">))</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to read file &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># create metadata retrieval object</span>
    <span class="k">if</span> <span class="n">field_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="n">PSR_FIELD_NAMES</span>
    <span class="n">filemetadata</span> <span class="o">=</span> <span class="n">FileMetadata</span><span class="p">(</span><span class="s1">&#39;PSR&#39;</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">additional_metadata</span><span class="p">,</span>
                                <span class="n">file_field_names</span><span class="p">,</span> <span class="n">exclude_fields</span><span class="p">,</span>
                                <span class="n">include_fields</span><span class="p">)</span>
    <span class="n">dBADU_to_dBm_hh</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;dBADU_to_dBm_hh&#39;</span><span class="p">)</span>
    <span class="n">dBADU_to_dBm_vv</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;dBADU_to_dBm_vv&#39;</span><span class="p">)</span>
    <span class="n">mfloss_h</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;matched_filter_loss_h&#39;</span><span class="p">)</span>
    <span class="n">mfloss_v</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;matched_filter_loss_v&#39;</span><span class="p">)</span>
    <span class="n">pathatt</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;path_attenuation&#39;</span><span class="p">)</span>

    <span class="n">cpi_header</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">read_psr_cpi_headers</span><span class="p">(</span><span class="n">filenames_psr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cpi_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># keep only valid items</span>
    <span class="n">prfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;prfs&#39;</span><span class="p">]))</span>
    <span class="n">items</span><span class="p">,</span> <span class="n">radar</span> <span class="o">=</span> <span class="n">get_item_numbers</span><span class="p">(</span>
        <span class="n">radar</span><span class="p">,</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_start&#39;</span><span class="p">],</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_stop&#39;</span><span class="p">],</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_start&#39;</span><span class="p">],</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_stop&#39;</span><span class="p">],</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;prfs&#39;</span><span class="p">],</span>
        <span class="n">prfs</span><span class="p">,</span> <span class="n">cpi</span><span class="o">=</span><span class="n">cpi</span><span class="p">,</span> <span class="n">ang_tol</span><span class="o">=</span><span class="n">ang_tol</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">items</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No items matching radar object&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;spectral_noise_power_hh_ADU&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;spectral_noise_power_vv_ADU&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;spectral_noise_power_hv_ADU&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;spectral_noise_power_vh_ADU&#39;</span><span class="p">):</span>
            <span class="n">field_data</span> <span class="o">=</span> <span class="n">get_spectral_noise</span><span class="p">(</span>
                <span class="n">radar</span><span class="p">,</span> <span class="n">cpi_header</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">undo_txcorr</span><span class="o">=</span><span class="n">undo_txcorr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_data</span> <span class="o">=</span> <span class="n">get_spectra_field</span><span class="p">(</span>
                <span class="n">radar</span><span class="p">,</span> <span class="n">filenames_psr</span><span class="p">,</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">],</span>
                <span class="n">header</span><span class="p">[</span><span class="s1">&#39;items_per_file&#39;</span><span class="p">],</span> <span class="n">items</span><span class="p">,</span> <span class="n">ind_rng</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="n">fold</span><span class="p">,</span>
                <span class="n">positive_away</span><span class="o">=</span><span class="n">positive_away</span><span class="p">)</span>

        <span class="n">field_dict</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="n">field_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span>
        <span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_dict</span>

    <span class="n">Doppler_velocity</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;Doppler_velocity&#39;</span><span class="p">)</span>
    <span class="n">Doppler_frequency</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;Doppler_frequency&#39;</span><span class="p">)</span>
    <span class="n">npulses</span> <span class="o">=</span> <span class="n">filemetadata</span><span class="p">(</span><span class="s1">&#39;number_of_pulses&#39;</span><span class="p">)</span>

    <span class="n">vel_data</span><span class="p">,</span> <span class="n">freq_data</span> <span class="o">=</span> <span class="n">get_Doppler_info</span><span class="p">(</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;prfs&#39;</span><span class="p">][</span><span class="n">items</span><span class="p">],</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">][</span><span class="n">items</span><span class="p">],</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.rsplambda&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="n">fold</span><span class="p">)</span>

    <span class="n">Doppler_velocity</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vel_data</span>
    <span class="n">Doppler_frequency</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq_data</span>
    <span class="n">npulses</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">][</span><span class="n">items</span><span class="p">]</span>

    <span class="c1"># get further metadata</span>
    <span class="n">pw_ind</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbpwidth&#39;</span><span class="p">]</span>

    <span class="n">dBADU_to_dBm_hh</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbdbmtologoffset&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]])</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;dBADU_to_dBm_hh&#39;</span><span class="p">:</span> <span class="n">dBADU_to_dBm_hh</span><span class="p">})</span>

    <span class="n">dBADU_to_dBm_vv</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbdpvdbmtologoffset&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]])</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;dBADU_to_dBm_vv&#39;</span><span class="p">:</span> <span class="n">dBADU_to_dBm_vv</span><span class="p">})</span>

    <span class="n">mfloss_h</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.gdrxmfloss&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]])</span>
    <span class="n">mfloss_v</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.gdrxmfloss&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]])</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;matched_filter_loss_h&#39;</span><span class="p">:</span> <span class="n">mfloss_h</span><span class="p">})</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;matched_filter_loss_v&#39;</span><span class="p">:</span> <span class="n">mfloss_v</span><span class="p">})</span>

    <span class="n">pathatt</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.rspathatt&#39;</span><span class="p">]])</span>
    <span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;path_attenuation&#39;</span><span class="p">:</span> <span class="n">pathatt</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">RadarSpectra</span><span class="p">(</span>
        <span class="n">radar</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">range</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">radar</span><span class="o">.</span><span class="n">scan_type</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">altitude</span><span class="p">,</span>
        <span class="n">radar</span><span class="o">.</span><span class="n">sweep_number</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">sweep_mode</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">fixed_angle</span><span class="p">,</span>
        <span class="n">radar</span><span class="o">.</span><span class="n">sweep_start_ray_index</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">sweep_end_ray_index</span><span class="p">,</span>
        <span class="n">radar</span><span class="o">.</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">elevation</span><span class="p">,</span> <span class="n">npulses</span><span class="p">,</span>
        <span class="n">Doppler_velocity</span><span class="o">=</span><span class="n">Doppler_velocity</span><span class="p">,</span> <span class="n">Doppler_frequency</span><span class="o">=</span><span class="n">Doppler_frequency</span><span class="p">,</span>
        <span class="n">rays_are_indexed</span><span class="o">=</span><span class="n">radar</span><span class="o">.</span><span class="n">rays_are_indexed</span><span class="p">,</span>
        <span class="n">ray_angle_res</span><span class="o">=</span><span class="n">radar</span><span class="o">.</span><span class="n">ray_angle_res</span><span class="p">,</span>
        <span class="n">instrument_parameters</span><span class="o">=</span><span class="n">radar</span><span class="o">.</span><span class="n">instrument_parameters</span><span class="p">,</span>
        <span class="n">radar_calibration</span><span class="o">=</span><span class="n">radar</span><span class="o">.</span><span class="n">radar_calibration</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">read_psr_cpi_headers</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the CPI data headers contained in multiple PSR files</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filenames : list of str</span>
<span class="sd">        Name of the PSR files</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cpi_header, header : dict</span>
<span class="sd">        Dictionary containing the PSR header data and the CPI headers data</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cpi_header</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;azi_start&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;azi_stop&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;ele_start&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;ele_stop&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;npulses&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;prfs&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;ngates&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;tx_pwr&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;noise&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="n">cpi_header_aux</span><span class="p">,</span> <span class="n">header_aux</span> <span class="o">=</span> <span class="n">read_psr_cpi_header</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cpi_header_aux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;File &#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39; could not be read&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">header_aux</span>
            <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;items_per_file&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">header_aux</span><span class="p">[</span><span class="s1">&#39;item.count&#39;</span><span class="p">]]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;item.count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">header</span><span class="p">[</span><span class="s1">&#39;item.count&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">header_aux</span><span class="p">[</span><span class="s1">&#39;item.count&#39;</span><span class="p">])</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;items_per_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header_aux</span><span class="p">[</span><span class="s1">&#39;item.count&#39;</span><span class="p">])</span>

        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cpi_header_aux</span><span class="p">[</span><span class="s1">&#39;azi_start&#39;</span><span class="p">])</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_stop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cpi_header_aux</span><span class="p">[</span><span class="s1">&#39;azi_stop&#39;</span><span class="p">])</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cpi_header_aux</span><span class="p">[</span><span class="s1">&#39;ele_start&#39;</span><span class="p">])</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_stop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cpi_header_aux</span><span class="p">[</span><span class="s1">&#39;ele_stop&#39;</span><span class="p">])</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cpi_header_aux</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">])</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;prfs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cpi_header_aux</span><span class="p">[</span><span class="s1">&#39;prfs&#39;</span><span class="p">])</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ngates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cpi_header_aux</span><span class="p">[</span><span class="s1">&#39;ngates&#39;</span><span class="p">])</span>
        <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cpi_header_aux</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;noise&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cpi_header_aux</span><span class="p">:</span>
            <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cpi_header_aux</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">])</span>

    <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_start&#39;</span><span class="p">])</span>
    <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_stop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;azi_stop&#39;</span><span class="p">])</span>
    <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_start&#39;</span><span class="p">])</span>
    <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_stop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ele_stop&#39;</span><span class="p">])</span>
    <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">])</span>
    <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;prfs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;prfs&#39;</span><span class="p">])</span>
    <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ngates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ngates&#39;</span><span class="p">])</span>
    <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">])</span>
    <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">])</span>
    <span class="n">header</span><span class="p">[</span><span class="s1">&#39;items_per_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;items_per_file&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">cpi_header</span><span class="p">,</span> <span class="n">header</span>


<div class="viewcode-block" id="read_psr_header"><a class="viewcode-back" href="../../../aux_io.html#pyart.aux_io.read_psr_header">[docs]</a><span class="k">def</span> <span class="nf">read_psr_header</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a PSR file header.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the PSR file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    header : dict</span>
<span class="sd">        Dictionary containing the PSR header data</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">txtfile</span><span class="p">:</span>
            <span class="c1"># read first line: ARCHIVE_HEADER_START</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">txtfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">while</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">txtfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

                <span class="k">if</span> <span class="s1">&#39;ARCHIVE_HEADER_END&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="n">strings</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">strings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">convert_data</span><span class="p">(</span><span class="n">strings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>

            <span class="c1"># read noise</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">txtfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;PSR REDUCED&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Header does not contain noise data&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">header</span>

            <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">while</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">txtfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">):</span>
                    <span class="k">break</span>

                <span class="n">strings</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">strings</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;noise&#39;</span><span class="p">:</span> <span class="n">noise</span><span class="p">})</span>

            <span class="k">return</span> <span class="n">header</span>
    <span class="k">except</span> <span class="ne">EnvironmentError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ee</span><span class="p">))</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to read file &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">header</span></div>


<div class="viewcode-block" id="read_psr_cpi_header"><a class="viewcode-back" href="../../../aux_io.html#pyart.aux_io.read_psr_cpi_header">[docs]</a><span class="k">def</span> <span class="nf">read_psr_cpi_header</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the CPI data headers contained in a PSR file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the PSR file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cpi_header, header : dict</span>
<span class="sd">        Dictionary containing the PSR header data and the CPI headers data</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load PSR library</span>
    <span class="n">psr_lib</span> <span class="o">=</span> <span class="n">get_library</span><span class="p">()</span>

    <span class="n">c_float_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span><span class="p">)</span>
    <span class="n">c_long_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">read_psr_header</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">nitems</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;item.count&#39;</span><span class="p">]</span>

    <span class="n">azi_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nitems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">azi_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nitems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ele_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nitems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ele_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nitems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">npulses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nitems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">prfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nitems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ngates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nitems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">tx_pwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nitems</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">c_filename</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">psr_lib</span><span class="o">.</span><span class="n">psr_getValueArrays</span><span class="p">(</span>
            <span class="n">c_filename</span><span class="p">,</span> <span class="n">azi_start</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">),</span>
            <span class="n">azi_stop</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">),</span>
            <span class="n">ele_start</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">),</span>
            <span class="n">ele_stop</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">),</span>
            <span class="n">npulses</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_long_p</span><span class="p">),</span>
            <span class="n">prfs</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">),</span>
            <span class="n">ngates</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_long_p</span><span class="p">),</span>
            <span class="n">tx_pwr</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_float_p</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">EnvironmentError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ee</span><span class="p">))</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to read file &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">noise</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;noise&#39;</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">npulses</span>

    <span class="n">cpi_header</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;azi_start&#39;</span><span class="p">:</span> <span class="n">azi_start</span><span class="p">,</span>
        <span class="s1">&#39;azi_stop&#39;</span><span class="p">:</span> <span class="n">azi_stop</span><span class="p">,</span>
        <span class="s1">&#39;ele_start&#39;</span><span class="p">:</span> <span class="n">ele_start</span><span class="p">,</span>
        <span class="s1">&#39;ele_stop&#39;</span><span class="p">:</span> <span class="n">ele_stop</span><span class="p">,</span>
        <span class="s1">&#39;npulses&#39;</span><span class="p">:</span> <span class="n">npulses</span><span class="p">,</span>
        <span class="s1">&#39;prfs&#39;</span><span class="p">:</span> <span class="n">prfs</span><span class="p">,</span>
        <span class="s1">&#39;ngates&#39;</span><span class="p">:</span> <span class="n">ngates</span><span class="p">,</span>
        <span class="s1">&#39;tx_pwr&#39;</span><span class="p">:</span> <span class="n">tx_pwr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
        <span class="s1">&#39;noise&#39;</span><span class="p">:</span> <span class="n">noise</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">cpi_header</span><span class="p">,</span> <span class="n">header</span></div>


<div class="viewcode-block" id="read_psr_spectra"><a class="viewcode-back" href="../../../aux_io.html#pyart.aux_io.read_psr_spectra">[docs]</a><span class="k">def</span> <span class="nf">read_psr_spectra</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the complex spectral data contained in a PSR file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the PSR file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spectra : 3D complex ndArray</span>
<span class="sd">       The complex spectra</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load PSR library</span>
    <span class="n">psr_lib</span> <span class="o">=</span> <span class="n">get_library</span><span class="p">()</span>

    <span class="n">c_filename</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">c_complex_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>

    <span class="n">cpi_header</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">read_psr_cpi_header</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cpi_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">nitems</span> <span class="o">=</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ngates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="n">ngates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ngates&#39;</span><span class="p">])</span>
    <span class="n">npulses_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">])</span>

    <span class="n">spectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span>
        <span class="p">(</span><span class="n">nitems</span><span class="p">,</span> <span class="n">ngates</span><span class="p">,</span> <span class="n">npulses_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nitems</span><span class="p">):</span>
        <span class="n">npulses</span> <span class="o">=</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;ngates&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">]):</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">npulses</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">psr_lib</span><span class="o">.</span><span class="n">psr_getPowerSpectrum</span><span class="p">(</span>
                    <span class="n">c_filename</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">gate</span><span class="p">),</span>
                    <span class="n">spectrum</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_complex_p</span><span class="p">))</span>
                <span class="n">spectra</span><span class="p">[</span><span class="n">item</span><span class="p">,</span> <span class="n">gate</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">npulses</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span>
            <span class="k">except</span> <span class="ne">EnvironmentError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ee</span><span class="p">))</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to get CPI element &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39; at range gate &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; from file &#39;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spectra</span></div>


<span class="k">def</span> <span class="nf">get_item_numbers</span><span class="p">(</span><span class="n">radar</span><span class="p">,</span> <span class="n">azi_start</span><span class="p">,</span> <span class="n">azi_stop</span><span class="p">,</span> <span class="n">ele_start</span><span class="p">,</span> <span class="n">ele_stop</span><span class="p">,</span>
                     <span class="n">prf_array</span><span class="p">,</span> <span class="n">prfs</span><span class="p">,</span> <span class="n">cpi</span><span class="o">=</span><span class="s1">&#39;low_prf&#39;</span><span class="p">,</span> <span class="n">ang_tol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the item numbers to be used and eventually modify the radar object</span>
<span class="sd">    to accomodate more angles</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radar: radar object</span>
<span class="sd">        the reference radar</span>
<span class="sd">    azi_start, azi_stop, ele_start, ele_stop : float array</span>
<span class="sd">        The start and stop angles of the CPI elements</span>
<span class="sd">    prf_array: float array</span>
<span class="sd">        The PRF of each CPI element</span>
<span class="sd">    prfs : float array</span>
<span class="sd">        The unique PRFs contained in the PSR file</span>
<span class="sd">    cpi : str</span>
<span class="sd">        The CPI to use. Can be &#39;low_prf&#39;, &#39;intermediate_prf&#39;, &#39;high_prf&#39;,</span>
<span class="sd">        &#39;mean&#39;, &#39;all&#39;. If &#39;mean&#39; the mean within the angle step is taken.</span>
<span class="sd">        If &#39;all&#39; the data is not filtered by PRF</span>
<span class="sd">    ang_tol : float</span>
<span class="sd">        Angle tolerance</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    items : int array</span>
<span class="sd">        the item number selected</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">radar</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">==</span> <span class="s1">&#39;ppi&#39;</span><span class="p">:</span>
        <span class="n">cpi_ang_center</span> <span class="o">=</span> <span class="n">azi_start</span><span class="o">+</span><span class="p">(</span><span class="n">azi_stop</span><span class="o">-</span><span class="n">azi_start</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">cpi_fixed_angle</span> <span class="o">=</span> <span class="n">ele_start</span> <span class="o">+</span><span class="p">(</span><span class="n">ele_stop</span><span class="o">-</span><span class="n">ele_start</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>

        <span class="n">ref_ang</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">azimuth</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">fixed_ang</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">elevation</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">radar</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">==</span> <span class="s1">&#39;rhi&#39;</span><span class="p">:</span>
        <span class="n">cpi_ang_center</span> <span class="o">=</span> <span class="n">ele_start</span> <span class="o">+</span><span class="p">(</span><span class="n">ele_stop</span><span class="o">-</span><span class="n">ele_start</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">cpi_fixed_angle</span> <span class="o">=</span> <span class="n">azi_start</span><span class="o">+</span><span class="p">(</span><span class="n">azi_stop</span><span class="o">-</span><span class="n">azi_start</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>

        <span class="n">ref_ang</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">elevation</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">fixed_ang</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">azimuth</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">prfs</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cpi</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">sweep_start</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">sweep_start_ray_index</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">sweep_end</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">sweep_end_ray_index</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">items_per_sweep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">items_aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cpi_ang_center</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">s_start</span><span class="p">,</span> <span class="n">s_end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sweep_start</span><span class="p">,</span> <span class="n">sweep_end</span><span class="p">)):</span>
            <span class="c1"># only angles within fixed angle tolerance</span>
            <span class="n">fixed</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">fixed_angle</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cpi_fixed_angle</span><span class="o">-</span><span class="n">fixed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ang_tol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">cpi_ang_center_aux</span> <span class="o">=</span> <span class="n">cpi_ang_center</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">items_aux2</span> <span class="o">=</span> <span class="n">items_aux</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

            <span class="c1"># get angles within radar limits</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">cpi_ang_center_aux</span> <span class="o">&gt;=</span> <span class="n">ref_ang</span><span class="p">[</span><span class="n">s_start</span><span class="p">]</span><span class="o">-</span><span class="n">ang_tol</span><span class="p">,</span>
                <span class="n">cpi_ang_center_aux</span> <span class="o">&lt;=</span> <span class="n">ref_ang</span><span class="p">[</span><span class="n">s_end</span><span class="p">]</span><span class="o">+</span><span class="n">ang_tol</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">items_aux2</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">items_per_sweep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items_per_sweep</span><span class="p">,</span> <span class="n">items_aux2</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">radar</span> <span class="o">=</span> <span class="n">change_rays</span><span class="p">(</span>
            <span class="n">radar</span><span class="p">,</span> <span class="n">cpi_ang_center</span><span class="p">[</span><span class="n">items</span><span class="p">],</span> <span class="n">cpi_fixed_angle</span><span class="p">[</span><span class="n">items</span><span class="p">],</span>
            <span class="n">items_per_sweep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">items</span><span class="p">,</span> <span class="n">radar</span>

    <span class="n">items_aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cpi_ang_center</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prfs</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cpi</span> <span class="o">==</span> <span class="s1">&#39;low_prf&#39;</span><span class="p">:</span>
            <span class="n">cpi_ang_center</span> <span class="o">=</span> <span class="n">cpi_ang_center</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">cpi_fixed_angle</span> <span class="o">=</span> <span class="n">cpi_fixed_angle</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">items_aux</span> <span class="o">=</span> <span class="n">items_aux</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">cpi</span> <span class="o">==</span> <span class="s1">&#39;intermediate_prf&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prfs</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">cpi_ang_center</span> <span class="o">=</span> <span class="n">cpi_ang_center</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">cpi_fixed_angle</span> <span class="o">=</span> <span class="n">cpi_fixed_angle</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">items_aux</span> <span class="o">=</span> <span class="n">items_aux</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Less than 3 different prfs. &#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;Low prf data will be used&#39;</span><span class="p">)</span>
                <span class="n">cpi_ang_center</span> <span class="o">=</span> <span class="n">cpi_ang_center</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">cpi_fixed_angle</span> <span class="o">=</span> <span class="n">cpi_fixed_angle</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">items_aux</span> <span class="o">=</span> <span class="n">items_aux</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">cpi</span> <span class="o">==</span> <span class="s1">&#39;high_prf&#39;</span><span class="p">:</span>
            <span class="n">cpi_ang_center</span> <span class="o">=</span> <span class="n">cpi_ang_center</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">cpi_fixed_angle</span> <span class="o">=</span> <span class="n">cpi_fixed_angle</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">items_aux</span> <span class="o">=</span> <span class="n">items_aux</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prfs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="n">cpi</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">cpi_ang_center_aux</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cpi_fixed_angle_aux</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">items_aux2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">prf</span> <span class="ow">in</span> <span class="n">prfs</span><span class="p">:</span>
                <span class="n">cpi_ang_center_aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpi_ang_center</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prf</span><span class="p">])</span>
                <span class="n">cpi_fixed_angle_aux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpi_fixed_angle</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prf</span><span class="p">])</span>
                <span class="n">items_aux2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items_aux</span><span class="p">[</span><span class="n">prf_array</span> <span class="o">==</span> <span class="n">prf</span><span class="p">])</span>

            <span class="n">cpi_ang_center</span> <span class="o">=</span> <span class="n">cpi_ang_center_aux</span>
            <span class="n">cpi_fixed_angle</span> <span class="o">=</span> <span class="n">cpi_fixed_angle_aux</span>
            <span class="n">items_aux</span> <span class="o">=</span> <span class="n">items_aux2</span>

    <span class="c1"># get items to extract</span>
    <span class="k">if</span> <span class="n">prfs</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cpi</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">prf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prfs</span><span class="p">):</span>
            <span class="n">cpi_fixed_angle_aux</span> <span class="o">=</span> <span class="n">cpi_fixed_angle</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">cpi_ang_center_aux</span> <span class="o">=</span> <span class="n">cpi_ang_center</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">items_aux2</span> <span class="o">=</span> <span class="n">items_aux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">items_aux4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ang</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ref_ang</span><span class="p">):</span>
                <span class="c1"># only angles within fixed angle tolerance</span>
                <span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed_ang</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cpi_fixed_angle_aux</span><span class="o">-</span><span class="n">fixed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ang_tol</span><span class="p">)</span>
                <span class="n">cpi_ang_center_aux2</span> <span class="o">=</span> <span class="n">cpi_ang_center_aux</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">items_aux3</span> <span class="o">=</span> <span class="n">items_aux2</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

                <span class="c1"># get angle closest to reference angle</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cpi_ang_center_aux2</span><span class="o">-</span><span class="n">ang</span><span class="p">))</span>
                <span class="n">items_aux4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items_aux4</span><span class="p">,</span> <span class="n">items_aux3</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items_aux4</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">items</span><span class="p">,</span> <span class="n">radar</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ang</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ref_ang</span><span class="p">):</span>
        <span class="c1"># only angles within fixed angle tolerance</span>
        <span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed_ang</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cpi_fixed_angle</span><span class="o">-</span><span class="n">fixed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ang_tol</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">cpi_ang_center_aux</span> <span class="o">=</span> <span class="n">cpi_ang_center</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">items_aux2</span> <span class="o">=</span> <span class="n">items_aux</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># get angle closest to reference angle</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cpi_ang_center_aux</span><span class="o">-</span><span class="n">ang</span><span class="p">))</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">items_aux2</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">items</span><span class="p">,</span> <span class="n">radar</span>


<span class="k">def</span> <span class="nf">get_field</span><span class="p">(</span><span class="n">radar</span><span class="p">,</span> <span class="n">cpi_header</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">nprfs</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span>
              <span class="n">undo_txcorr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cpi</span><span class="o">=</span><span class="s1">&#39;low_prf&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the field corresponding to the reference radar</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radar: radar object</span>
<span class="sd">        the reference radar</span>
<span class="sd">    cpi_header, header : dict</span>
<span class="sd">        dictionaries containing the PSR file header and CPI headers data</span>
<span class="sd">    items : int array</span>
<span class="sd">        array containing the items to select</span>
<span class="sd">    nprfs: float</span>
<span class="sd">        The number of different prfs in the file</span>
<span class="sd">    field_name : str</span>
<span class="sd">        The name of the field to filter</span>
<span class="sd">    undo_txcorr : bool</span>
<span class="sd">        If True and field is a noise field the correction of the received</span>
<span class="sd">        signal by the transmitted power is undone</span>
<span class="sd">    cpi : str</span>
<span class="sd">        The CPI to use. Can be &#39;low_prf&#39;, &#39;intermediate_prf&#39;, &#39;high_prf&#39;,</span>
<span class="sd">        &#39;all&#39;. If &#39;all&#39; the mean within the angle step is taken</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    field_data : 2D float array</span>
<span class="sd">        The PSR data in the format of the reference radar fields</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;noisedBZ_hh&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBZ_vv&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBm_hh&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;noisedBm_vv&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBADU_hh&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBADU_vv&#39;</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">undo_txcorr</span><span class="p">:</span>
            <span class="n">field</span><span class="p">[</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span>
                <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">][</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">/</span>
                <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbtxpowkw&#39;</span><span class="p">][</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbpwidth&#39;</span><span class="p">]])</span>

    <span class="k">elif</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;transmitted_signal_power_h&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;transmitted_signal_power_v&#39;</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">nprfs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cpi</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">field_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">nprfs</span><span class="p">))</span>
        <span class="n">npulses_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">nprfs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">npulses</span> <span class="o">=</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nprfs</span><span class="p">):</span>
            <span class="n">items_aux</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items_aux</span><span class="p">):</span>
                <span class="n">field_filt</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">npulses</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="n">npulses_filt</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">npulses</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="n">field_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">field_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">npulses_filt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="n">field_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">field_filt</span><span class="p">,</span> <span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">ngates</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_spectral_noise</span><span class="p">(</span><span class="n">radar</span><span class="p">,</span> <span class="n">cpi_header</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">undo_txcorr</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the field corresponding to the reference radar</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radar: radar object</span>
<span class="sd">        the reference radar</span>
<span class="sd">    cpi_header, header : dict</span>
<span class="sd">        dictionaries containing the PSR file header and CPI headers data</span>
<span class="sd">    items : int array</span>
<span class="sd">        array containing the items to select</span>
<span class="sd">    field_name : str</span>
<span class="sd">        The name of the field to filter</span>
<span class="sd">    undo_txcorr : bool</span>
<span class="sd">        If True and field is a noise field the correction of the received</span>
<span class="sd">        signal by the transmitted power is undone</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    field_data : 2D float array</span>
<span class="sd">        The PSR data in the format of the reference radar fields</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">undo_txcorr</span><span class="p">:</span>
        <span class="n">field</span><span class="p">[</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span>
            <span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">][</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;tx_pwr&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">/</span>
            <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbtxpowkw&#39;</span><span class="p">][</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbpwidth&#39;</span><span class="p">]])</span>

    <span class="n">field_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
        <span class="n">field_filt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="n">npulses_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cpi_header</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">][</span><span class="n">items</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
        <span class="n">field_filt</span><span class="p">,</span> <span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">ngates</span><span class="p">,</span> <span class="n">npulses_max</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_spectra_field</span><span class="p">(</span><span class="n">radar</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">npulses</span><span class="p">,</span> <span class="n">items_per_file</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span>
                      <span class="n">ind_rng</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">positive_away</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the field corresponding to the reference radar</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radar: radar object</span>
<span class="sd">        the reference radar</span>
<span class="sd">    filename : str</span>
<span class="sd">        name of the PSR file</span>
<span class="sd">    npulses : int array</span>
<span class="sd">        array containing the number of pulses for each item</span>
<span class="sd">    items_per_file : int array</span>
<span class="sd">        array containing the number of items in each PSR file</span>
<span class="sd">    items : int array</span>
<span class="sd">        array containing the items to select</span>
<span class="sd">    ind_rng : int array</span>
<span class="sd">        array containing the indices to the range gates to select</span>
<span class="sd">    fold : Bool</span>
<span class="sd">        If True the spectra is folded</span>
<span class="sd">    positive_away : Bool</span>
<span class="sd">        If True positive Doppler velocities are way from the radar</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spectra : 3D complex float array</span>
<span class="sd">        The complex spectra field</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load PSR library</span>
    <span class="n">psr_lib</span> <span class="o">=</span> <span class="n">get_library</span><span class="p">()</span>

    <span class="n">c_complex_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>

    <span class="n">npulses_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">npulses</span><span class="p">[</span><span class="n">items</span><span class="p">])</span>

    <span class="n">spectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span>
        <span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">ngates</span><span class="p">,</span> <span class="n">npulses_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>

    <span class="n">accu_items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">items_per_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ray</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
        <span class="c1"># get file to read and item number within file</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">accu_items</span> <span class="o">&gt;=</span> <span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">item_aux</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">item_aux</span> <span class="o">=</span> <span class="n">item</span> <span class="o">-</span> <span class="n">accu_items</span><span class="p">[</span><span class="n">ind</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">c_filename</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">rng</span><span class="p">,</span> <span class="n">gate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ind_rng</span><span class="p">):</span>
            <span class="n">npulses_item</span> <span class="o">=</span> <span class="n">npulses</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">npulses_item</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">psr_lib</span><span class="o">.</span><span class="n">psr_getPowerSpectrum</span><span class="p">(</span>
                    <span class="n">c_filename</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">item_aux</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">gate</span><span class="p">),</span>
                    <span class="n">spectrum</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">c_complex_p</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">fold</span><span class="p">:</span>
                    <span class="n">nfold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">npulses_item</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
                    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="n">nfold</span><span class="p">:],</span> <span class="n">spectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nfold</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">positive_away</span><span class="p">:</span>
                    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">spectra</span><span class="p">[</span><span class="n">ray</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">npulses_item</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span>
            <span class="k">except</span> <span class="ne">EnvironmentError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ee</span><span class="p">))</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to get CPI element &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s1">&#39; at range gate &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; from file &#39;</span><span class="o">+</span><span class="n">filenames</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

    <span class="n">spectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spectra</span>


<span class="k">def</span> <span class="nf">get_Doppler_info</span><span class="p">(</span><span class="n">prfs</span><span class="p">,</span> <span class="n">npulses</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the Doppler information</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prfs: float array</span>
<span class="sd">        the PRF at each ray</span>
<span class="sd">    npulses : float array</span>
<span class="sd">        the number of pulses per ray</span>
<span class="sd">    wavelength : float</span>
<span class="sd">        the radar wavelength [m]</span>
<span class="sd">    fold : Bool</span>
<span class="sd">        If True the spectra is folded</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Doppler_velocity, Doppler_frequency : 2D float array</span>
<span class="sd">        The Doppler velocity and Doppler frequency bins for each ray</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrays</span> <span class="o">=</span> <span class="n">npulses</span><span class="o">.</span><span class="n">size</span>
    <span class="n">npulses_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">npulses</span><span class="p">)</span>
    <span class="n">freq_res</span> <span class="o">=</span> <span class="n">prfs</span><span class="o">/</span><span class="n">npulses</span>
    <span class="n">vel_res</span> <span class="o">=</span> <span class="n">freq_res</span><span class="o">*</span><span class="n">wavelength</span><span class="o">/</span><span class="mf">2.</span>

    <span class="n">Doppler_frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">nrays</span><span class="p">,</span> <span class="n">npulses_max</span><span class="p">))</span>
    <span class="n">Doppler_velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">((</span><span class="n">nrays</span><span class="p">,</span> <span class="n">npulses_max</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ray</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrays</span><span class="p">):</span>
        <span class="n">pulses_ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">npulses</span><span class="p">[</span><span class="n">ray</span><span class="p">])</span>
        <span class="n">npulses_ray</span> <span class="o">=</span> <span class="n">pulses_ray</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">fold</span><span class="p">:</span>
            <span class="n">nfold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">npulses_ray</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
            <span class="n">pulses_ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pulses_ray</span><span class="p">[</span><span class="n">nfold</span><span class="p">:]</span><span class="o">-</span><span class="n">npulses_ray</span><span class="p">,</span> <span class="n">pulses_ray</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nfold</span><span class="p">])</span>

        <span class="n">Doppler_frequency</span><span class="p">[</span><span class="n">ray</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">npulses_ray</span><span class="p">]</span> <span class="o">=</span> <span class="n">pulses_ray</span><span class="o">*</span><span class="n">freq_res</span><span class="p">[</span><span class="n">ray</span><span class="p">]</span>
        <span class="n">Doppler_velocity</span><span class="p">[</span><span class="n">ray</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">npulses_ray</span><span class="p">]</span> <span class="o">=</span> <span class="n">pulses_ray</span><span class="o">*</span><span class="n">vel_res</span><span class="p">[</span><span class="n">ray</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Doppler_velocity</span><span class="p">,</span> <span class="n">Doppler_frequency</span>



<span class="k">def</span> <span class="nf">get_noise_field</span><span class="p">(</span><span class="n">radar</span><span class="p">,</span> <span class="n">field_data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Puts the noise field in the desired units</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radar: radar object</span>
<span class="sd">        the reference radar</span>
<span class="sd">    field_data : 2D float array</span>
<span class="sd">        The PSR data in the format of the reference radar fields</span>
<span class="sd">    header : dict</span>
<span class="sd">        Dictionary containing the PSR file metadata</span>
<span class="sd">    field_name : str</span>
<span class="sd">        The name of the field</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    field_data : 2D float array</span>
<span class="sd">        The PSR data in the format of the reference radar fields</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_data</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;noisedBADU_hh&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBADU_vv&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">field_data</span>

    <span class="n">pw_ind</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbpwidth&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;noisedBZ_hh&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBm_hh&#39;</span><span class="p">):</span>
        <span class="n">dBadu2dBm</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbdbmtologoffset&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dBadu2dBm</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.spbdpvdbmtologoffset&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]</span>

    <span class="n">field_data</span> <span class="o">=</span> <span class="n">field_data</span><span class="o">+</span><span class="n">dBadu2dBm</span>

    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;noisedBm_hh&#39;</span><span class="p">,</span> <span class="s1">&#39;noisedBm_vv&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">field_data</span>

    <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s1">&#39;noisedBZ_hh&#39;</span><span class="p">:</span>
        <span class="n">radconst</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.rspdphradconst&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">radconst</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.rspdpvradconst&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]</span>
    <span class="n">mfloss</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.gdrxmfloss&#39;</span><span class="p">][</span><span class="n">pw_ind</span><span class="p">]</span>
    <span class="n">pathatt</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;states.rspathatt&#39;</span><span class="p">]</span>

    <span class="n">rangeKm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1000.</span><span class="p">),</span> <span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">ngates</span><span class="p">))</span>

    <span class="n">field_data</span> <span class="o">+=</span> <span class="n">radconst</span><span class="o">+</span><span class="n">mfloss</span><span class="o">+</span><span class="n">pathatt</span><span class="o">*</span><span class="n">rangeKm</span><span class="o">+</span><span class="mf">20.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">rangeKm</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">field_data</span>


<div class="viewcode-block" id="convert_data"><a class="viewcode-back" href="../../../aux_io.html#pyart.aux_io.convert_data">[docs]</a><span class="k">def</span> <span class="nf">convert_data</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts an string of values into the corresponding format</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    values: str</span>
<span class="sd">        string containg the values to convert</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    values : int, float, str or 1D array of int, float or str</span>
<span class="sd">        The converted values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">values</span></div>


<span class="k">def</span> <span class="nf">get_library</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return the link to C-shared library</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        psr_lib : link</span>
<span class="sd">            loaded PSR C-library</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">library_path</span> <span class="o">=</span> <span class="n">get_library_path</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">MissingOptionalDependency</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MissingOptionalDependency</span><span class="p">(</span><span class="s2">&quot; PSR library path NOT defined&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">psr_lib</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">library_path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;libDX50.so&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ee</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ee</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">MissingOptionalDependency</span><span class="p">(</span><span class="s1">&#39;Unable to load PSR library&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">psr_lib</span>


<span class="k">def</span> <span class="nf">get_library_path</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    find valid library path</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    psr_lib_path : str</span>
<span class="sd">        library path</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if path is correct</span>
    <span class="n">library_paths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PSRLIB_PATH&#39;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/pyrad/src/libDX50/lib/&#39;</span><span class="p">]</span>
    <span class="n">library_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">library_paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">library_path</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">library_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MissingOptionalDependency</span><span class="p">(</span><span class="s2">&quot; PSR library path NOT defined&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">library_path</span>


<span class="k">def</span> <span class="nf">change_rays</span><span class="p">(</span><span class="n">radar</span><span class="p">,</span> <span class="n">moving_angle</span><span class="p">,</span> <span class="n">fixed_angle</span><span class="p">,</span> <span class="n">rays_per_sweep</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the radar object to accomodate new rays</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radar : radar object</span>
<span class="sd">        the radar to modify</span>
<span class="sd">    moving_angle : float array</span>
<span class="sd">        The moving angles</span>
<span class="sd">    fixed_angle : float array</span>
<span class="sd">        The fixed angles</span>
<span class="sd">    rays_per_sweep : array of ints</span>
<span class="sd">        The number of rays per sweep</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_radar : radar object</span>
<span class="sd">        The modified radar</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_radar</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)</span>
    <span class="n">new_radar</span><span class="o">.</span><span class="n">nrays</span> <span class="o">=</span> <span class="n">moving_angle</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="n">radar</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">==</span> <span class="s1">&#39;ppi&#39;</span><span class="p">:</span>
        <span class="n">new_radar</span><span class="o">.</span><span class="n">azimuth</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moving_angle</span>
        <span class="n">new_radar</span><span class="o">.</span><span class="n">elevation</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_angle</span>
    <span class="k">elif</span> <span class="n">radar</span><span class="o">.</span><span class="n">scan_type</span> <span class="o">==</span> <span class="s1">&#39;rhi&#39;</span><span class="p">:</span>
        <span class="n">new_radar</span><span class="o">.</span><span class="n">azimuth</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_angle</span>
        <span class="n">new_radar</span><span class="o">.</span><span class="n">elevation</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moving_angle</span>

    <span class="n">ray_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_radar</span><span class="o">.</span><span class="n">nrays</span><span class="o">/</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">)</span>

    <span class="c1"># change time</span>
    <span class="n">time_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">radar</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">ray_factor</span><span class="p">,</span>
        <span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radar</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">ray_factor</span><span class="p">)</span>
    <span class="n">time_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">time_res</span><span class="p">,</span> <span class="n">ray_factor</span><span class="p">),</span> <span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">ray_factor</span><span class="p">)),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">new_radar</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">ray_factor</span><span class="p">)</span><span class="o">+</span> <span class="n">time_sum</span><span class="p">)</span>

    <span class="n">new_radar</span><span class="o">.</span><span class="n">sweep_start_ray_index</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">rays_per_sweep</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">new_radar</span><span class="o">.</span><span class="n">sweep_end_ray_index</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">rays_per_sweep</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">new_radar</span><span class="o">.</span><span class="n">init_rays_per_sweep</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">new_radar</span><span class="o">.</span><span class="n">ray_angle_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_radar</span><span class="o">.</span><span class="n">ray_angle_res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">ray_factor</span>

    <span class="n">new_radar</span><span class="o">.</span><span class="n">init_gate_x_y_z</span><span class="p">()</span>
    <span class="n">new_radar</span><span class="o">.</span><span class="n">init_gate_longitude_latitude</span><span class="p">()</span>
    <span class="n">new_radar</span><span class="o">.</span><span class="n">init_gate_altitude</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">new_radar</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pyart-mch 0.4.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, meteoswiss-mdr.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>